<html>
  <head>
    <title>serial rent</title>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <style type="text/css">
      body {
        font-family: verdana;
      }
      table {
        border-collapse: collapse;
      }
      table,td,th {
        border: 1px solid black;
      }
      td,th {
        padding: 4px;
      }
      tr:nth-child(odd) {
        background: #EEE;
      }
      tr:nth-child(even) {
        background: #FFF;
      }
      .block {
        border: 1px solid black;
        margin: 1em;
        padding: 1em;
      }
    </style>
  </head>
  <body>
    <h1>series download manager</h1>

    <div class="block">
      <h2>Tasks</h2>
      <ul>
        <li><a href="" id="doUpdate">update database</a>
        <li><a href="" id="doDownload">download updates</a>
        <li><a href="" id="doMove">move downloaded</a>
      </ul>
    </div>

    <div class="block">
      <h2>Search for series on thetvdb.com</h2>
      <form id="form_search"> 
        <input type="text" id="search_text"/> 
        <input type="submit" value="Search"/>
      </form>

      <div id="div_results">
        <h3>Results</h3>
        <table>
          <thead><th>tvdb id</th><th>name</th><th>actions</th></thead>
          <tbody id="search_results"></tbody>
        </table>
      </div>
    </div>

    <div class="block">
      <h2>Subscriptions</h2>
      <table>
        <thead><th>tvdb id</th><th>name</th><th>actions</th></thead>
        <tbody id="subscriptions"></tbody>
      </table>

      <div id="details">

        <h3 id="heading_details">Details</h3>

        <form id="form_eztv_name">
          EZTV Name:
          <input type="text" id="eztv_name"/>
          <input type="submit" value="Rename"/>
        </form>

        <h3>Episodes</h3>
        <table>
          <thead><th>season</th><th>episode</th><th>name</th><th>status</th></thead>
          <tbody id="episodes"></tbody>
        </table>
      </div>
    </div>
    <div class="block">
      <h2>Log</h2>
      <ul id="log"></ul>

  </div>
    <script>

      function tvdb_link(id) {
        return '<a href="http://thetvdb.com/index.php?tab=series&id='+id+'">tvdb</a>';
      }

      function updateLog() {
        $.getJSON('/log', function(data) {
          var items = [];
          $.each(data, function(key, val) {
            items.push('<li>' + val);
          });
          $("#log").html(items.join(''));
        });
      }

      function tr(items) {
        return ' <tr><td>' + items.join('</td><td>') + '</td></tr> ';
      }

      function button(title, fun) {
        return ' <a href="" onClick="javascript:'+fun+'; return false;">'+title+'</a> ';
      }

      function showDetails(id) {
        if (id == null) {
          $("#episodes").html('');
          $("#details").hide();
          $.current_series = null;
        }
        else {
          $("#details").show();
          $.current_series = id;
          function onRecvEpisodes(data) {
            var items = [];
            $.each(data, function(key, val) {
              items.push(tr([val.season_number, val.episode_number, val.episode_name, val.state]));
            });
            $("#episodes").html(items.join(''));
          };
          $.getJSON('/subscription/' + id + '/eztv_name', function(data) {
            $("#eztv_name").val(data);
          });
          $.getJSON('/subscription/' + id + '/series_name', function(data) {
            $("#heading_details").html('Details for ' + data + button('x', 'showDetails(null)'));
          });
          $.getJSON('/subscription/' + id + '/episodes', onRecvEpisodes);
        }
      }

      function removeSubscription(id) {
        $.ajax({
          url:'/subscription/' + id,
          type:'DELETE',
          success: getSubscriptions });
      }

      function getSubscriptions() {
        function onRecvSubs(data) {
          var items = [];
          $.each(data, function(key, val) {
            id = val.tvdb_series;
            items.push(tr([id, button(val.series_name, 'showDetails('+id+')'), button('remove', 'removeSubscription('+id+')') + tvdb_link(id)]));
          });
          $("#subscriptions").html(items.join(''));
        };
        showDetails(null);
        $.getJSON('/subscription', onRecvSubs);
      }

      function onAddSubscription(id) {
        $.ajax({
          url: '/subscription/'+id, 
          type: 'PUT', 
          success: getSubscriptions});
      }

      function onRecvResults(data) {
        var items = [];
        $.each(data, function(key, val) {
          items.push(tr([val.id, val.name, button('add', 'onAddSubscription('+val.id+');') + tvdb_link(val.id)]));
        });
        $("#search_results").html(items.join(''));
        $("#div_results").show();
      }


      $(document).ready( function() {

        $("#form_search").submit(function() {
          var query = $("#search_text").val();
          $.getJSON('/search/' + query, onRecvResults);
          return false;
        });

        $("#form_eztv_name").submit(function() {
          var query = $("#eztv_name").val();
          var id = $.current_series;
          $.ajax({
            'url':'/subscription/' + id + '/eztv_name/' + query,
            'type':'POST'
          });
          return false;
        });

        $("#doUpdate").click(function() {
          showDetails(null);
          $.getJSON('/updates', function(data) {});
          return false;
        });

        $("#doMove").click(function() {
          showDetails(null);
          $.getJSON('/updates/move', function(data) {});
          return false;
        });
        $("#doDownload").click(function() {
          showDetails(null);
          $.getJSON('/updates/download', function(data) {});
          return false;
        });

        showDetails(null);
        window.setInterval(updateLog, 10000);
        updateLog();
        getSubscriptions();

        $('#div_results').hide();
      });

    </script>
  </body>
</html>
