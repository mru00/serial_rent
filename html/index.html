<html>
  <head>
    <title>serial rent</title>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="jquery.autoSuggest.js"></script>
    <link rel="stylesheet" type="text/css" href="autoSuggest.css" media="screen"/>
  </head>
  <body>
    <h1>series download manager</h1>
    <h2>Search for series on thetvdb.com</h2>
    <form id="form_search"> 
      <input type="text" id="search_text"/> 
      <input type="submit"/>
    </form>
    <h3>Results</h3>
    <table>
      <thead><th>tvdb id</th><th>name</th><th>actions</th></thead>
      <tbody id="search_results"></tbody>
    </table>

    <h2>Tasks</h2>
    <a href="" id="doUpdate">update database</a>
    <a href="" id="doDownload">download updates</a>

    <h2>Subscriptions</h2>
    <table>
      <thead><th>tvdb id</th><th>name</th><th>actions</th></thead>
      <tbody id="subscriptions"></tbody>
    </table>

    <div id="details">
      
    <h3>Details</h3>

    <form id="form_eztv_name">
      EZTV Name:
      <input type="text" id="eztv_name"/>
      <input type="submit"/>
    </form>

    <h3>Episodes</h3>


    <table>
      <thead><th>season</th><th>episode</th><th>name</th><th>status</th></thead>
      <tbody id="episodes"></tbody>
    </table>
  </div>

    <h2>Log</h2>
    <ul id="log"></ul>

    <script>

      function tvdb_link(id) {
        return '<a href="http://thetvdb.com/index.php?tab=series&id='+id+'">tvdb</a>';
      }

      function updateLog() {
        $.getJSON('/log', function(data) {
          var items = [];
          $.each(data, function(key, val) {
            items.push('<li>' + val);
          });
          $("#log").html(items.join(''));
        });
      }

      function tr(items) {
        return '<tr><td>' + items.join('</td><td>') + '</td></tr>';
      }

      function button(title, fun) {
        return '<a href="" onClick="javascript:'+fun+'; return false;">'+title+'</a>';
      }

      function showDetails(id) {
        if (id == null) {
          $("#episodes").html('');
          $("#details").hide();
          $.current_series = null;
        }
        else {
          $("#details").show();
          $.current_series = id;
          function onRecvEpisodes(data) {
            var items = [];
            $.each(data, function(key, val) {
              items.push(tr([val.season_number, val.episode_number, val.name, val.state]));
            });
            $("#episodes").html(items.join(''));
          };
          function onRecvEZTV(data) {
            $("#eztv_name").val(data);
          };
          $.getJSON('/subscription/' + id + '/eztv_name', onRecvEZTV);
          $.getJSON('/subscription/' + id + '/episodes', onRecvEpisodes);
        }
      }

      function removeSubscription(id) {
        $.ajax({
          url:'/subscription/' + id,
          type:'DELETE',
          success: getSubscriptions });
      }

      function getSubscriptions() {
        function onRecvSubs(data) {
          var items = [];
          $.each(data, function(key, val) {
            id = val.tvdb_series;
            items.push(tr([id, button(val.name, 'showDetails('+id+')'), button('remove', 'removeSubscription('+id+')'), tvdb_link(id)]));
          });
          $("#subscriptions").html(items.join(''));
        };
        showDetails(null);
        $.getJSON('/subscription', onRecvSubs);
      }

      function onAddSubscription(id) {
        $.ajax({
          url: '/subscription/'+id, 
          type: 'PUT', 
          success: getSubscriptions});
      }

      function onRecvResults(data) {
        var items = [];
        $.each(data, function(key, val) {
          items.push(tr([val.id, val.name, button('add', 'onAddSubscription('+val.id+');'), tvdb_link(val.id)]));
        });
        $("#search_results").html(items.join(''));
      }


      $(document).ready( function() {

        $("#form_search").submit(function() {
          var query = $("#search_text").val();
          $.getJSON('/search/' + query, onRecvResults);
          return false;
        });

        $("#form_eztv_name").submit(function() {
          var query = $("#eztv_name").val();
          var id = $.current_series;
          $.ajax({
            'url':'/subscription/' + id + '/eztv_name/' + query,
            'type':'POST'
          });
          return false;
        });

        $("#doUpdate").click(function() {
          showDetails(null);
          $.getJSON('/updates', function(data) {});
          return false;
        });

        $("#doDownload").click(function() {
          showDetails(null);
          $.getJSON('/updates/download', function(data) {});
          return false;
        });

        showDetails(null);
        window.setInterval(updateLog, 10000);
        updateLog();
        getSubscriptions();

      });

    </script>
  </body>
</html>
